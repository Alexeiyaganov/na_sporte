<!-- frontend/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportEvents Map</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .app-header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: #007bff;
            color: white;
            border-bottom: 3px solid #0056b3;
        }

        .tab-button:hover:not(.active) {
            background: #e9ecef;
        }

        .filters-panel {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
        }

        .location-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .location-btn:hover {
            background: #218838;
        }

        .location-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .map-container {
            flex: 1;
            min-height: 400px;
        }

        .event-popup, .user-popup {
            max-width: 250px;
        }

        .event-popup h4, .user-popup h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .event-popup button, .user-popup button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        .event-popup button:hover, .user-popup button:hover {
            background: #0056b3;
        }

        .user-marker {
            background: none;
            border: none;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-container">
            <header class="app-header">
                <h1>üèÉ SportEvents Map</h1>
            </header>

            <nav class="nav-tabs">
                <button
                    @click="activeTab = 'events'"
                    :class="{ active: activeTab === 'events' }"
                    class="tab-button"
                >
                    üóìÔ∏è –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
                </button>
                <button
                    @click="activeTab = 'people'"
                    :class="{ active: activeTab === 'people' }"
                    class="tab-button"
                >
                    üë• –õ—é–¥–∏ —Ä—è–¥–æ–º
                </button>
            </nav>

            <!-- –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
            <div v-if="activeTab === 'events'" class="filters-panel">
                <select v-model="filters.sport" class="filter-select">
                    <option value="">–í—Å–µ –≤–∏–¥—ã</option>
                    <option value="–±–µ–≥">üèÉ –ë–µ–≥</option>
                    <option value="–≤–µ–ª–æ—Å–ø–æ—Ä—Ç">üö¥ –í–µ–ª–æ—Å–ø–æ—Ä—Ç</option>
                    <option value="–ª—ã–∂–∏">‚õ∑Ô∏è –õ—ã–∂–∏</option>
                    <option value="–π–æ–≥–∞">üßò –ô–æ–≥–∞</option>
                    <option value="–ø–ª–∞–≤–∞–Ω–∏–µ">üèä –ü–ª–∞–≤–∞–Ω–∏–µ</option>
                </select>

                <select v-model="filters.radius" class="filter-select" :disabled="!userLocation">
                    <option value="5">5 –∫–º</option>
                    <option value="10">10 –∫–º</option>
                    <option value="25">25 –∫–º</option>
                    <option value="50">50 –∫–º</option>
                </select>

                <button @click="shareLocation" class="location-btn">
                    üìç {{ userLocation ? '–û–±–Ω–æ–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é' : '–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ' }}
                </button>

                <span v-if="loading" style="color: #666;">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...
                </span>
            </div>

            <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–∂–∏–º–∞ "–õ—é–¥–∏" -->
            <div v-if="activeTab === 'people'" class="filters-panel">
                <div v-if="!isSharingLocation">
                    <input
                        v-model="userComment"
                        placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–∏—Ö —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö..."
                        class="filter-select"
                        style="min-width: 250px;"
                    />
                    <button @click="startSharing" class="location-btn">
                        üë• –°—Ç–∞—Ç—å –≤–∏–¥–∏–º—ã–º
                    </button>
                </div>
                <div v-else>
                    <span style="color: #28a745;">‚úî –í—ã –≤–∏–¥–∏–º—ã –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</span>
                    <button @click="stopSharing" class="location-btn" style="background: #dc3545;">
                        ‚ùå –°–∫—Ä—ã—Ç—å—Å—è
                    </button>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–∞ -->
            <div id="map" class="map-container"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const { createApp, ref, onMounted, computed, watch } = Vue;

        createApp({
            setup() {
                const activeTab = ref('events');
                const events = ref([]);
                const loading = ref(false);
                const userLocation = ref(null);
                const isSharingLocation = ref(false);
                const userComment = ref('');
                const map = ref(null);
                const markers = ref([]);

                const filters = ref({
                    sport: '',
                    radius: 10
                });

                // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
                const loadEvents = async () => {
                    loading.value = true;
                    try {
                        console.log('Loading events...');
                        const params = new URLSearchParams();
                        if (filters.value.sport) params.append('sport', filters.value.sport);
                        if (userLocation.value) {
                            params.append('lat', userLocation.value.lat);
                            params.append('lng', userLocation.value.lng);
                            params.append('radius', filters.value.radius);
                        }

                        const response = await fetch(`http://localhost:8001/api/events?${params}`);
                        if (!response.ok) throw new Error('Network response was not ok');

                        events.value = await response.json();
                        console.log('Loaded events:', events.value);
                        updateMapMarkers();
                    } catch (error) {
                        console.error('Failed to load events:', error);
                        // Fallback to mock data
                        events.value = getMockEvents();
                        updateMapMarkers();
                    } finally {
                        loading.value = false;
                    }
                };

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
                const initMap = () => {
                    console.log('Initializing map...');
                    map.value = L.map('map').setView([55.7558, 37.6173], 10);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(map.value);

                    console.log('Map initialized');
                    loadEvents();
                };

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
                const updateMapMarkers = () => {
                    if (!map.value) return;

                    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                    markers.value.forEach(marker => {
                        map.value.removeLayer(marker);
                    });
                    markers.value = [];

                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                    events.value.forEach(event => {
                        const marker = L.marker([event.lat, event.lng])
                            .addTo(map.value)
                            .bindPopup(`
                                <div class="event-popup">
                                    <h4>${event.title}</h4>
                                    <p>${event.description}</p>
                                    <p><strong>–°–ø–æ—Ä—Ç:</strong> ${event.sport}</p>
                                    <p><strong>–î–∞—Ç–∞:</strong> ${event.date}</p>
                                    <button onclick="alert('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é!')">
                                        –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
                                    </button>
                                </div>
                            `);

                        markers.value.push(marker);
                    });

                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
                    if (userLocation.value) {
                        map.value.setView([userLocation.value.lat, userLocation.value.lng], 12);
                    }

                    console.log(`Added ${markers.value.length} markers to map`);
                };

                // –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
                const shareLocation = () => {
                    if (!navigator.geolocation) {
                        alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation.value = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            console.log('User location:', userLocation.value);
                            loadEvents(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è —Å —É—á–µ—Ç–æ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                            alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞! –ö–∞—Ä—Ç–∞ –æ—Ç—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –≤–∞—à–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏.');
                        },
                        (error) => {
                            console.error('Error getting location:', error);
                            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                };

                // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–õ—é–¥–∏"
                const startSharing = async () => {
                    if (!navigator.geolocation) {
                        alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const location = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            userLocation.value = location;
                            isSharingLocation.value = true;

                            try {
                                const response = await fetch('http://localhost:8002/api/users/location', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        user_id: 123456789, // demo user ID
                                        username: 'Demo User',
                                        lat: location.lat,
                                        lng: location.lng,
                                        comment: userComment.value || '–õ—é–±–ª—é —Å–ø–æ—Ä—Ç!',
                                        sports: ['–±–µ–≥', '–≤–µ–ª–æ—Å–ø–æ—Ä—Ç']
                                    })
                                });

                                if (response.ok) {
                                    alert('–¢–µ–ø–µ—Ä—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤–∞—Å –Ω–∞ –∫–∞—Ä—Ç–µ!');
                                } else {
                                    throw new Error('Failed to update location');
                                }
                            } catch (error) {
                                console.error('Error updating location:', error);
                                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
                            }
                        },
                        (error) => {
                            console.error('Error getting location:', error);
                            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é');
                        }
                    );
                };

                const stopSharing = () => {
                    isSharingLocation.value = false;
                    userLocation.value = null;
                    alert('–í—ã –±–æ–ª—å—à–µ –Ω–µ –≤–∏–¥–∏–º—ã –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º');
                };

                // Mock –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
                const getMockEvents = () => {
                    return [
                        {
                            id: 1,
                            title: "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –º–∞—Ä–∞—Ñ–æ–Ω 2024",
                            description: "–ï–∂–µ–≥–æ–¥–Ω—ã–π –æ—Å–µ–Ω–Ω–∏–π –º–∞—Ä–∞—Ñ–æ–Ω —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤—ã",
                            sport: "–±–µ–≥",
                            date: "2024-09-15",
                            location: "–ú–æ—Å–∫–≤–∞, –í–æ—Ä–æ–±—å–µ–≤—ã –≥–æ—Ä—ã",
                            lat: 55.710,
                            lng: 37.553
                        },
                        {
                            id: 2,
                            title: "–ù–æ—á–Ω–æ–π –≤–µ–ª–æ–ø—Ä–æ–±–µ–≥",
                            description: "–ù–æ—á–Ω–∞—è –≤–µ–ª–æ–ø—Ä–æ–≥—É–ª–∫–∞ –ø–æ –æ—Å–≤–µ—â–µ–Ω–Ω—ã–º —É–ª–∏—Ü–∞–º –≥–æ—Ä–æ–¥–∞",
                            sport: "–≤–µ–ª–æ—Å–ø–æ—Ä—Ç",
                            date: "2024-10-20",
                            location: "–ú–æ—Å–∫–≤–∞, –ü–∞—Ä–∫ –ì–æ—Ä—å–∫–æ–≥–æ",
                            lat: 55.731,
                            lng: 37.603
                        }
                    ];
                };

                onMounted(() => {
                    console.log('App mounted');
                    initMap();
                });

                // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                watch(() => filters.value.sport, loadEvents);
                watch(() => filters.value.radius, loadEvents);
                watch(() => activeTab.value, (newTab) => {
                    if (newTab === 'events') {
                        loadEvents();
                    }
                });

                return {
                    activeTab,
                    events,
                    loading,
                    userLocation,
                    isSharingLocation,
                    userComment,
                    filters,
                    loadEvents,
                    shareLocation,
                    startSharing,
                    stopSharing
                };
            }
        }).mount('#app');
    </script>
</body>
</html>